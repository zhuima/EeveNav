---
import PostList from '@/components/post/PostList.astro'
import Layout from '@/layouts/Layout.astro'
import PostLayout from '@/layouts/PostLayout.astro'
import { getDatabase } from '../lib/database'
import { ensureDatabaseData } from '../lib/migration'

// 确保数据库有数据
await ensureDatabaseData()

const tags = [
  {
    name: '最新',
    slug: '',
  },
  {
    name: 'github',
    slug: 'github',
  },
]

// 从数据库获取文章，而不是从内容集合
const db = getDatabase()
const allPosts = await db.getPosts()
// 只获取没有external_url的自写博客文章
const blogPosts = allPosts.filter(post => !post.external_url || post.external_url.trim() === '')
const categories = await db.getCategories()

// 转换数据库文章格式为与内容集合兼容的格式
const formattedPosts = blogPosts.map(post => ({
  slug: post.slug,
  data: {
    title: post.title,
    date: post.date,
    des: post.des,
    cover: post.cover,
    category: post.category,
    tags: post.tags,
  }
}))

// 按日期排序
const sortedPosts = formattedPosts.sort(
  (a, b) => b.data.date.getTime() - a.data.date.getTime()
)

// 获取最新的20个post
const latestPosts = sortedPosts.slice(0, 20)
const lastPage = Math.ceil(sortedPosts.length / 20)

const page = {
  data: latestPosts,
  currentPage: 1,
  lastPage,
  url: {
    cuurent: `/blog/page/1`,
    next: null,
    prev: null,
    first: null,
    last: null,
  },
}
if (lastPage > 1) {
   page.url.next = `/blog/page/2`
   page.url.last = `/blog/page/${lastPage}`
}

// SEO配置
const seoConfig = {
  title: `博客文章 - AffDirs | ${allPosts.length}篇精选技术文章`,
  description: `探索${allPosts.length}篇精选技术文章，涵盖${categories.length}个分类。包含前端开发、设计资源、工具推荐、编程技巧等内容。分享最新的技术趋势和实用经验。`,
  keywords: [
    '技术博客', '前端开发', '设计资源', '工具推荐', '编程技巧',
    '技术分享', '开发经验', '设计灵感', 'Web开发', '程序员',
    'AffDirs博客', '技术文章', '编程教程'
  ],
  type: 'website' as const,
  image: '/og.jpg',
  imageAlt: 'AffDirs技术博客 - 精选技术文章与开发经验分享'
}
---

<Layout {...seoConfig}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="py-6 sm:py-8">
      <!-- 页面标题和描述 -->
      <header class="mb-8">
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-4">博客文章</h1>
        <p class="text-lg text-gray-600 max-w-3xl">
          精选{allPosts.length}篇技术文章，涵盖前端开发、设计资源、工具推荐等多个领域。
          分享最新的技术趋势和实用开发经验。
        </p>
      </header>
      
      <!-- 面包屑导航 -->
      <nav class="mb-6" aria-label="面包屑导航">
        <ol class="flex items-center space-x-2 text-sm text-gray-500">
          <li>
            <a href="/" class="hover:text-gray-700 transition-colors">首页</a>
          </li>
          <li>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </li>
          <li aria-current="page" class="text-gray-900 font-medium">博客文章</li>
        </ol>
      </nav>
      
      <!-- 标签过滤器 -->
      <section class="mb-8" aria-label="文章分类标签">
        <h2 class="sr-only">按分类筛选文章</h2>
        <div class="flex flex-wrap pt-4 sm:pt-6 w-full gap-2 sm:gap-4">
          {tags.map(tag => (
            <a 
              href={tag.slug ? `/tags/${tag.slug}` : '/blog'}
              class="block"
              aria-label={tag.slug ? `查看${tag.name}分类的文章` : '查看所有最新文章'}
            >
              <span class={`inline-block px-3 py-1 sm:px-4 sm:py-2 text-sm sm:text-base rounded-full transition-colors ${
                tag.slug === '' 
                  ? 'bg-blue-500 text-white' 
                  : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}>
                {tag.name}
              </span>
            </a>
          ))}
        </div>
      </section>
      
      <!-- 文章列表 -->
      <main>
        <PostLayout>
          <PostList page={page} />
        </PostLayout>
      </main>
      
      <!-- 统计信息 -->
      <aside class="mt-12 p-6 bg-gray-50 rounded-xl">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">博客统计</h2>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
          <div class="text-center">
            <div class="text-2xl font-bold text-blue-600">{allPosts.length}</div>
            <div class="text-sm text-gray-600">总文章数</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-green-600">{categories.length}</div>
            <div class="text-sm text-gray-600">分类数量</div>
          </div>
          <div class="text-center md:col-span-1 col-span-2">
            <div class="text-2xl font-bold text-purple-600">{lastPage}</div>
            <div class="text-sm text-gray-600">总页数</div>
          </div>
        </div>
      </aside>
    </div>
  </div>
</Layout>