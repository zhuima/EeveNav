---
import { Image } from 'astro:assets'
import { getDate } from '@/utils'

const { post } = Astro.props

// 确保 post.data 存在，处理可能直接来自数据库的文章格式
const postData = post.data || post;
const postSlug = post.slug;
const postTitle = postData.title;
const postDes = postData.des;
const postCover = postData.cover;
const postDate = postData.date;
const postTags = postData.tags || [];
const externalUrl = postData.external_url;
---

<div class="w-full">
  <article class="rounded-lg shadow-lg h-full overflow-hidden transition-all duration-300 hover:shadow-xl">
    <div class="cursor-pointer w-full relative aspect-[16/9] overflow-hidden">
      <a href={`/posts/${postSlug}`} target={externalUrl ? "_blank" : "_self"} class="block w-full h-full">
        <Image
          loading="lazy"
          class="w-full h-full object-cover transition-transform duration-300 hover:scale-105 rounded-t-lg"
          src={postCover}
          width={400}
          height={225}
          alt={postTitle}
        />
        {externalUrl && (
          <div class="absolute top-2 right-2 bg-blue-500 text-white p-1 rounded-full">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
              <polyline points="15 3 21 3 21 9"></polyline>
              <line x1="10" y1="14" x2="21" y2="3"></line>
            </svg>
          </div>
        )}
      </a>

      <div>
      </div>
    </div>

    <div class="p-3 sm:p-4">
      <div class="flex flex-col space-y-1.5 min-h-[60px]">
        <h3 class="text-base sm:text-lg font-semibold tracking-tight line-clamp-2 flex items-start">
          {postTitle}
          {externalUrl && (
            <span class="ml-1 text-blue-500 flex-shrink-0">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                <polyline points="15 3 21 3 21 9"></polyline>
                <line x1="10" y1="14" x2="21" y2="3"></line>
              </svg>
            </span>
          )}
        </h3>
        <h5 class="text-xs sm:text-sm text-muted-foreground text-right">by ibucoin</h5>
      </div>

      <section class="text-xs sm:text-sm font-medium mt-2 min-h-[40px] line-clamp-2">
        {postDes}
      </section>
      <div class="mt-3 sm:mt-4 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2">
        <div class="flex items-center gap-1 sm:gap-2 flex-wrap">
          {
            postTags?.slice(0, 3).map(tag => (
              <a
                href={`/tags/${encodeURI(tag)}`}
                target="_self"
                class="px-2 py-0.5 sm:px-2.5 sm:py-1 rounded-lg text-xs text-red-600 font-medium bg-red-50/80 capitalize"
              >
                {tag}
              </a>
            ))
          }
          {postTags?.length > 3 && (
            <span class="px-2 py-0.5 sm:px-2.5 sm:py-1 rounded-lg text-xs text-gray-600 font-medium bg-gray-50/80">
              +{postTags.length - 3}
            </span>
          )}
        </div>
        <div class="text-xs text-muted-foreground flex-shrink-0">
          {getDate(postDate)}
        </div>
      </div>
    </div>
  </article>
</div>
